{% extends 'base.html.twig' %}

{% block title %}Mes stades visités{% endblock %}

{% block body_id %}dashboard{% endblock %}

{% block body %}
<section class="container text-center py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="fw-bold mb-4 display-5 text-dark">Mes stades visités</h1>
      <p class="fs-5 mb-4 text-secondary">
        Retrouvez sur la carte ci-dessous tous les clubs que vous avez visités.
      </p>
    </div>
  </div>
</section>

<div class="container mb-5" style="max-width:600px;">
  <h4 class="mb-3 text-center">Ajouter un club visité</h4>
  <div class="position-relative mb-3">
    <input type="text" id="club-search" class="form-control" placeholder="Rechercher un club...">
    <ul id="suggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1000;"></ul>
  </div>
  <button id="add-club" class="btn btn-dark w-100" disabled>Ajouter à mes stades visités</button>
</div>

<div id="map" style="height: 800px; width: 80%; margin: 0 auto 50px auto;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    if (document.body.id !== 'dashboard') return;

    // --- Initialisation de la carte ---
    const clubs = {{ clubs|json_encode()|raw }};
    const map = L.map('map').setView([46.8, 2.3], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markerLayer = L.layerGroup().addTo(map);
    const markers = {};

    // --- Fonction message succès ---
    function showSuccess(msg) {
        let div = document.createElement('div');
        div.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
        div.style.zIndex = 2000;
        div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 2000);
    }

    // --- Liste des clubs visités ---
    const visitedList = document.createElement('ul');
    visitedList.className = 'list-group mb-3';
    document.querySelector('#map').insertAdjacentElement('beforebegin', visitedList);

    // --- Ajout des markers initiaux ---
    clubs.forEach(club => {
        if (club.latitude && club.longitude) {
            const iconUrl = "{{ asset('images/logos/') }}" + club.logo;
            const clubIcon = L.icon({ iconUrl, iconSize: [40,40], iconAnchor:[20,40], popupAnchor:[0,-40] });
            const marker = L.marker([club.latitude, club.longitude], { icon: clubIcon }).addTo(markerLayer);

            const popupContent = document.createElement('div');
            popupContent.innerHTML = `
                <b>${club.name}</b><br>
                <small>${club.stadium ?? 'Stade inconnu'}</small><br>
                <img src="/images/bin.png" alt="Supprimer" style="height:20px;cursor:pointer;margin-top:5px;">
            `;
            marker.bindPopup(popupContent);

            marker.on('popupopen', () => {
                popupContent.querySelector('img').addEventListener('click', async () => {
                    const res = await fetch('/api/remove-visited', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({clubId: club.id})
                    });
                    const data = await res.json();
                    if (data.success) {
                        showSuccess('Club supprimé ✅');
                        markerLayer.removeLayer(marker);
                        const li = visitedList.querySelector(`li[data-club-id="${club.id}"]`);
                        if (li) li.remove();
                    }
                });
            });

            markers[club.id] = marker;

            // Ajouter dans la liste
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.dataset.clubId = club.id;
            li.innerHTML = `<span>${club.name}</span>
                            <img src="/images/bin.png" alt="Supprimer" style="height:20px;cursor:pointer;">`;
            visitedList.appendChild(li);

            li.querySelector('img').addEventListener('click', async () => {
                const res = await fetch('/api/remove-visited', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({clubId: club.id})
                });
                const data = await res.json();
                if (data.success) {
                    showSuccess('Club supprimé ✅');
                    markerLayer.removeLayer(marker);
                    li.remove();
                }
            });
        }
    });

    // --- Recherche et ajout ---
    const input = document.getElementById('club-search');
    const suggestions = document.getElementById('suggestions');
    const addBtn = document.getElementById('add-club');
    let selectedClub = null;

    input.addEventListener('input', async () => {
        const query = input.value.trim();
        suggestions.innerHTML = '';
        selectedClub = null;
        addBtn.disabled = true;

        if (query.length < 2) return;

        const response = await fetch(`/api/clubs?q=${encodeURIComponent(query)}`);
        const clubsRes = await response.json();

        clubsRes.forEach(club => {
            // Vérifier doublon
            if (visitedList.querySelector(`li[data-club-id="${club.id}"]`)) return;

            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action d-flex align-items-center';
            li.dataset.clubId = club.id;
            li.innerHTML = `<img src="/images/logos/${club.logo}" style="height:25px;width:25px;margin-right:10px;">${club.name}`;
            li.addEventListener('click', () => {
                input.value = club.name;
                selectedClub = club.id;
                suggestions.innerHTML = '';
                addBtn.disabled = false;
            });
            suggestions.appendChild(li);
        });
    });

    addBtn.addEventListener('click', async () => {
        if (!selectedClub) return;

        const response = await fetch('/api/add-visited', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ clubId: selectedClub })
        });
        const data = await response.json();
        if (!data.success) return alert('Erreur ajout');

        showSuccess('✅ Club ajouté avec succès !');
        input.value = '';
        addBtn.disabled = true;

        // Récupérer le club complet depuis la réponse du backend
        const club = clubs.find(c => c.id === selectedClub);
        if (!club) return;

        // Ajouter marker
        if (club.latitude && club.longitude) {
            const iconUrl = "{{ asset('images/logos/') }}" + club.logo;
            const clubIcon = L.icon({ iconUrl, iconSize:[40,40], iconAnchor:[20,40], popupAnchor:[0,-40] });
            const marker = L.marker([club.latitude, club.longitude], { icon: clubIcon }).addTo(markerLayer);

            const popupContent = document.createElement('div');
            popupContent.innerHTML = `
                <b>${club.name}</b><br>
                <small>${club.stadium ?? 'Stade inconnu'}</small><br>
                <img src="/images/bin.png" alt="Supprimer" style="height:20px;cursor:pointer;margin-top:5px;">
            `;
            marker.bindPopup(popupContent);

            marker.on('popupopen', () => {
                popupContent.querySelector('img').addEventListener('click', async () => {
                    const res = await fetch('/api/remove-visited', {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({clubId: selectedClub})
                    });
                    const data = await res.json();
                    if (data.success) {
                        showSuccess('Club supprimé ✅');
                        markerLayer.removeLayer(marker);
                        const li = visitedList.querySelector(`li[data-club-id="${club.id}"]`);
                        if (li) li.remove();
                    }
                });
            });

            markers[club.id] = marker;
        }

        // Ajouter dans la liste
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.dataset.clubId = club.id;
        li.innerHTML = `<span>${club.name}</span>
                        <img src="/images/bin.png" alt="Supprimer" style="height:20px;cursor:pointer;">`;
        visitedList.appendChild(li);

        li.querySelector('img').addEventListener('click', async () => {
            const res = await fetch('/api/remove-visited', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({clubId: club.id})
            });
            const data = await res.json();
            if (data.success) {
                showSuccess('Club supprimé ✅');
                markerLayer.removeLayer(markers[club.id]);
                li.remove();
            }
        });
    });
});
</script>
{% endblock %}

