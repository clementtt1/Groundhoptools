{% extends 'base.html.twig' %}

{% block title %}Mes stades visités{% endblock %}

{% block body_id %}dashboard{% endblock %}

{% block body %}
<section class="container text-center py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="fw-bold mb-4 display-5 text-dark">Mes stades visités</h1>
      <p class="fs-5 mb-4 text-secondary">
        Retrouvez sur la carte ci-dessous tous les clubs que vous avez visités.
      </p>
    </div>
  </div>
</section>

<div class="container mb-5" style="max-width:600px;">
  <h4 class="mb-3 text-center">Ajouter un club visité</h4>
  <div class="position-relative mb-3">
    <input type="text" id="club-search" class="form-control" placeholder="Rechercher un club...">
    <ul id="suggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1000;"></ul>
  </div>
  <button id="add-club" class="btn btn-dark w-100" disabled>Ajouter à mes stades visités</button>
</div>

<div id="map" style="height: 800px; width: 80%; margin: 0 auto 50px auto;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    if (document.body.id !== 'dashboard') return;

    // --- INITIALISATION DE LA CARTE ---
    const clubs = {{ clubs|json_encode()|raw }};
    const map = L.map('map').setView([46.8, 2.3], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // --- AFFICHAGE DES CLUBS VISITÉS ---
    clubs.forEach(club => {
        if (club.latitude && club.longitude) {
            const iconUrl = "{{ asset('images/logos/') }}" + club.logo;
            const clubIcon = L.icon({
                iconUrl: iconUrl,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            const popupContent = `
                <b>${club.name}</b><br>
                <small>${club.stadium ?? 'Stade inconnu'}</small>
            `;

            L.marker([club.latitude, club.longitude], { icon: clubIcon })
                .addTo(map)
                .bindPopup(popupContent);
        }
    });

    // --- SÉLECTION DE NOUVEAUX CLUBS ---
    const input = document.getElementById('club-search');
    const suggestions = document.getElementById('suggestions');
    const addBtn = document.getElementById('add-club');
    let selectedClub = null;

    input.addEventListener('input', async () => {
        const query = input.value.trim();
        suggestions.innerHTML = '';
        selectedClub = null;
        addBtn.disabled = true;

        if (query.length < 2) return;

        try {
            const response = await fetch(`/api/clubs?q=${encodeURIComponent(query)}`);
            const clubs = await response.json();

            if (clubs.length === 0) {
                suggestions.innerHTML = `<li class="list-group-item text-muted">Aucun résultat</li>`;
                return;
            }

            clubs.forEach(club => {
                const logoUrl = "{{ asset('images/logos/') }}" + club.logo;
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action d-flex align-items-center';
                li.innerHTML = `
                    <img src="${logoUrl}" alt="${club.name}" 
                         style="width:30px; height:30px; object-fit:contain; margin-right:10px; border-radius:4px; border:1px solid #eee;">
                    <span>${club.name}</span>
                `;

                li.addEventListener('click', () => {
                    input.value = club.name;
                    selectedClub = club.id;
                    suggestions.innerHTML = '';
                    addBtn.disabled = false;
                });

                suggestions.appendChild(li);
            });
        } catch (err) {
            console.error('Erreur chargement clubs :', err);
            suggestions.innerHTML = `<li class="list-group-item text-danger">Erreur de chargement</li>`;
        }
    });

    // --- AJOUT DU CLUB EN BDD ---
    addBtn.addEventListener('click', async () => {
        if (!selectedClub) return;

        try {
            const response = await fetch('/api/add-visited', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clubId: selectedClub })
            });

            const data = await response.json();

            if (data.success) {
                alert('✅ Club ajouté avec succès !');
                input.value = '';
                addBtn.disabled = true;
                location.reload(); // met à jour la carte
            } else {
                alert('❌ Erreur : ' + (data.error || 'inconnue'));
            }
        } catch (err) {
            console.error(err);
            alert('Erreur lors de l’ajout du club.');
        }
    });

    // Fermer les suggestions si clic en dehors
    document.addEventListener('click', e => {
        if (!suggestions.contains(e.target) && e.target !== input) {
            suggestions.innerHTML = '';
        }
    });
});
</script>
{% endblock %}

