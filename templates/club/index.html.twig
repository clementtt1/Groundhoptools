{% extends 'base.html.twig' %}

{% block title %}Carte des clubs{% endblock %}
{% block body_id %}homepage{% endblock %}

{% block body %}
<section class="container text-center py-3">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="fw-bold mb-4 display-5 text-dark">Groundhoptools</h1>
      <p class="fs-5 mb-4 text-secondary">
        <strong>Groundhoptools</strong> est un outil de <em>Groundhopping</em> con√ßu pour faciliter la recherche de matchs se trouvant autour de vous.
      </p>
      <p class="fs-5 mb-4 text-secondary">
        Pour l‚Äôutiliser, il suffit de s√©lectionner deux dates dans le calendrier ci-dessous : la date de d√©but et la date de fin de votre s√©jour.
        Si vous souhaitez voir les matchs sur une seule journ√©e, s√©lectionnez simplement ce jour comme date de d√©but <strong>et</strong> de fin.
      </p>
      <p class="fs-5 mb-4 text-secondary">
        Une fois la p√©riode choisie, cliquez sur le bouton <strong>¬´ Voir les clubs √† domicile ¬ª</strong>.
        Tous les clubs jouant √† domicile s‚Äôaffichent alors. En cliquant sur un club, vous pouvez voir le nom de son stade
        ainsi que la liste de ses adversaires pendant la p√©riode s√©lectionn√©e.
      </p>
      <p class="fs-5 text-secondary">
        Cr√©er un compte vous permet d‚Äôenregistrer les clubs d√©j√† visit√©s afin de les masquer dans vos prochains r√©sultats de recherche pour rendre votre exp√©rience de Groundhopping encore plus fluide et personnalis√©e.
      </p>
    </div>
  </div>
</section>

<div class="container mb-4 text-center">
  <div class="d-flex justify-content-center gap-2 flex-wrap">
    <input type="text" id="daterange" class="form-control text-center" 
           placeholder="Choisis une p√©riode" style="max-width: 250px;">
    <button id="load-matches" class="btn btn-dark">Voir les clubs √† domicile</button>
  </div>

  <div class="d-flex justify-content-center mt-3">
    <div class="form-check form-switch d-flex align-items-center">
        <label class="form-check-label fw-bold mb-0" for="hide-visited">
            Masquer les clubs d√©j√† visit√©s
        </label>
        <input class="form-check-input me-2" type="checkbox" id="hide-visited">
    </div>
</div>


<div id="map" style="height: 800px; width: 80%; margin: 0 auto 50px auto;"></div>

<!-- Leaflet CSS et JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- DateRangePicker dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
{% endblock %}

{% block javascripts %}
<script>
window.clubs = {{ clubs|json_encode()|raw }};

document.addEventListener('DOMContentLoaded', () => {
    if (document.body.id !== 'homepage') return;

    const map = L.map('map').setView([46.8, 2.3], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];

    function afficherClubs(liste, matchs = []) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        liste.forEach(club => {
            if (!club.latitude || !club.longitude) return;

            const iconUrl = "{{ asset('images/logos/') }}" + club.logo;
            const clubIcon = L.icon({
                iconUrl: iconUrl,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            const matchsClub = matchs.filter(m => m.homeTeam.toLowerCase() === club.name.toLowerCase());
            let popupContent = `<b>${club.name}</b><br>${club.stadium}`;

            if (matchsClub.length > 0) {
                popupContent += `<br><br><b>Matchs √† domicile :</b><br>`;
                matchsClub.forEach(m => {
                    const dateObj = new Date(m.startTime);
                    const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const jour = dateObj.toLocaleDateString('fr-FR');
                    popupContent += `${jour} - ${heure} üÜö ${m.awayTeam}<br>`;
                });
            }

            const marker = L.marker([club.latitude, club.longitude], { icon: clubIcon })
                .addTo(map)
                .bindPopup(popupContent);

            markers.push(marker);
        });
    }

    // Affiche tous les clubs par d√©faut au premier chargement
    afficherClubs(window.clubs);

    // DateRangePicker
    let startDate = moment();
    let endDate = moment();

    $('#daterange').daterangepicker({
        startDate: startDate,
        endDate: endDate,
        autoUpdateInput: true,
        locale: {
            format: 'DD/MM/YYYY',
            applyLabel: 'Appliquer',
            cancelLabel: 'Annuler',
            fromLabel: 'De',
            toLabel: '√Ä',
            customRangeLabel: 'Personnalis√©',
            daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
            monthNames: [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ],
            firstDay: 1
        }
    }, function(start, end) {
        startDate = start;
        endDate = end;
    });

    document.getElementById('load-matches').addEventListener('click', () => {
        const start = startDate.format('YYYY-MM-DD');
        const end = endDate.format('YYYY-MM-DD');
        const hideVisited = document.getElementById('hide-visited').checked ? 1 : 0;
        chargerMatchs(start, end, hideVisited);
    });

    async function chargerMatchs(startDate, endDate, hideVisited = 0) {
        try {
            const response = await fetch(`{{ path('api_matchs') }}?start=${startDate}&end=${endDate}&hideVisited=${hideVisited}`);
            const data = await response.json();

            if (!data.events || data.events.length === 0) {
                afficherClubs([]);
                return;
            }

            const clubsDomicile = data.events.map(e => e.homeTeam.toLowerCase());
            const clubsAffiches = window.clubs.filter(c => clubsDomicile.includes(c.name.toLowerCase()));
            afficherClubs(clubsAffiches, data.events);
        } catch (err) {
            console.error("Erreur chargement matchs:", err);
            alert("Impossible de charger les donn√©es.");
        }
    }
});
</script>
{% endblock %}
