{% extends 'base.html.twig' %}

{% block title %}Carte des clubs{% endblock %}

{% block body %}
<h1 class="text-center">Groundhoptools</h1>

<div style="text-align:center; margin-bottom: 20px;">
    <label for="start-date" style="font-weight: bold;">Date de d√©but :</label>
    <input type="date" id="start-date" value="{{ "now"|date("Y-m-d") }}" />

    <label for="end-date" style="font-weight: bold;">Date de fin :</label>
    <input type="date" id="end-date" value="{{ "now"|date("Y-m-d") }}" />

    <button id="load-matches" class="btn btn-primary">Voir les clubs √† domicile</button>
</div>


<div id="map" style="height: 800px; width: 80%; margin: 0 auto; display: block;"></div>

<!-- Leaflet CSS et JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([46.8, 2.3], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const clubs = {{ clubs|json_encode()|raw }};
let markers = [];

function afficherClubs(liste, matchs = []) {
    // Supprimer les anciens marqueurs
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    // Options pour formatter la date en fran√ßais
    const optionsDate = { weekday: 'long', day: 'numeric', month: 'short' };

    liste.forEach(club => {
        const iconUrl = "{{ asset('images/logos/') }}" + club.logo;
        const clubIcon = L.icon({
            iconUrl: iconUrl,
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
        });

        // Filtrer les matchs √† domicile pour ce club
        const matchsClub = matchs.filter(m => m.homeTeam.toLowerCase() === club.name.toLowerCase());

        // Construire le contenu du popup
        let popupContent = `<b>${club.name}</b><br>${club.stadium}`;

        if (matchsClub.length > 0) {
            popupContent += `<br><br><b>Matchs √† domicile :</b><br>`;
            matchsClub.forEach(m => {
                // On r√©cup√®re la date et l'heure du match
                const dateMatch = new Date(m.date + 'T' + (m.time || "00:00"));
                const jour = dateMatch.toLocaleDateString('fr-FR', optionsDate);
                const heure = dateMatch.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                popupContent += `<span style="font-weight:bold;">${jour}</span> √† ${heure} - ${m.awayTeam}<br>`;
            });
        }

        const marker = L.marker([club.latitude, club.longitude], { icon: clubIcon })
            .addTo(map)
            .bindPopup(popupContent);

        markers.push(marker);
    });
}



// Affiche tous les clubs par d√©faut
afficherClubs(clubsAffiches, data.events);

async function chargerMatchs(startDate, endDate) {
    console.log("üìÖ P√©riode s√©lectionn√©e :", startDate, "->", endDate);

    try {
        const response = await fetch(`/api/matchs?start=${startDate}&end=${endDate}`);
        const data = await response.json();

        console.log("üì¶ Donn√©es JSON r√©cup√©r√©es :", data);

        if (!data.events || data.events.length === 0) {
            console.log("‚ö†Ô∏è Aucun match trouv√© pour cette p√©riode");
            afficherClubs([]); // on vide la carte
            return;
        }

        // Liste des clubs √† domicile (insensible √† la casse)
        const clubsDomicile = data.events.map(e => e.homeTeam.toLowerCase());

        // Filtrer les clubs qui jouent √† domicile
        const clubsAffiches = clubs.filter(c => 
            clubsDomicile.includes(c.name.toLowerCase())
        );

        console.log("‚úÖ Clubs affich√©s sur la carte :", clubsAffiches.map(c => c.name));
        afficherClubs(clubsAffiches);

    } catch (err) {
        console.error("‚ùå Erreur lors du chargement des matchs :", err);
        alert("Impossible de charger les donn√©es.");
    }
}

document.getElementById('load-matches').addEventListener('click', () => {
    const start = document.getElementById('start-date').value;
    const end = document.getElementById('end-date').value;

    if (!start || !end) {
        alert("Merci de choisir les deux dates !");
        return;
    }

    if (start > end) {
        alert("La date de d√©but doit √™tre avant la date de fin !");
        return;
    }

    chargerMatchs(start, end);
});


</script>


{% endblock %}
