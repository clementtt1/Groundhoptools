{% extends 'base.html.twig' %}

{% block title %}Carte des clubs{% endblock %}

{% block body %}
<h1 class="text-center mb-4">Groundhoptools</h1>

<div class="container mb-4 text-center">
    <div class="d-flex justify-content-center gap-2 flex-wrap">
        <input type="text" id="daterange" class="form-control text-center" 
               placeholder="Choisis une p√©riode" style="max-width: 250px;">
        <button id="load-matches" class="btn btn-dark">Voir les clubs √† domicile</button>
    </div>
</div>

<div id="map" style="height: 800px; width: 80%; margin: 0 auto 50px auto;"></div>

<!-- Leaflet CSS et JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- ‚úÖ Seulement les d√©pendances n√©cessaires au DateRangePicker -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<script>
const map = L.map('map').setView([46.8, 2.3], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const clubs = {{ clubs|json_encode()|raw }};
let markers = [];

function afficherClubs(liste, matchs = []) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    liste.forEach(club => {
        const iconUrl = "{{ asset('images/logos/') }}" + club.logo;
        const clubIcon = L.icon({
            iconUrl: iconUrl,
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
        });

        const matchsClub = matchs.filter(m => m.homeTeam.toLowerCase() === club.name.toLowerCase());
        let popupContent = `<b>${club.name}</b><br>${club.stadium}`;
        if (matchsClub.length > 0) {
            popupContent += `<br><br><b>Matchs √† domicile :</b><br>`;
            matchsClub.forEach(m => {
                const dateObj = new Date(m.startTime);
                const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const jour = dateObj.toLocaleDateString('fr-FR');
                popupContent += `${jour} - ${heure} üÜö ${m.awayTeam}<br>`;
            });
        }

        const marker = L.marker([club.latitude, club.longitude], { icon: clubIcon })
            .addTo(map)
            .bindPopup(popupContent);

        markers.push(marker);
    });
}

// Affiche tous les clubs par d√©faut
afficherClubs(clubs);

// --- Initialisation du DateRangePicker ---
let startDate = moment();
let endDate = moment();

$('#daterange').daterangepicker({
    startDate: startDate,
    endDate: endDate,
    autoUpdateInput: true,
    locale: {
        format: 'DD/MM/YYYY',
        applyLabel: 'Appliquer',
        cancelLabel: 'Annuler',
        fromLabel: 'De',
        toLabel: '√Ä',
        customRangeLabel: 'Personnalis√©',
        daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
        monthNames: [
            'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
            'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ],
        firstDay: 1
    }
}, function(start, end) {
    startDate = start;
    endDate = end;
});

// --- Chargement des matchs sur clic ---r
document.getElementById('load-matches').addEventListener('click', () => {
    const start = startDate.format('YYYY-MM-DD');
    const end = endDate.format('YYYY-MM-DD');
    chargerMatchs(start, end);
});

async function chargerMatchs(startDate, endDate) {
    console.log("üìÖ P√©riode s√©lectionn√©e :", startDate, "->", endDate);

    try {
        const response = await fetch(`{{ path('api_matchs') }}?start=${startDate}&end=${endDate}`);


        const data = await response.json();

        if (!data.events || data.events.length === 0) {
            console.log("‚ö†Ô∏è Aucun match trouv√© pour cette p√©riode");
            afficherClubs([]);
            return;
        }

        const clubsDomicile = data.events.map(e => e.homeTeam.toLowerCase());
        const clubsAffiches = clubs.filter(c => clubsDomicile.includes(c.name.toLowerCase()));

        afficherClubs(clubsAffiches, data.events);

    } catch (err) {
        console.error("‚ùå Erreur lors du chargement des matchs :", err);
        alert("Impossible de charger les donn√©es.");
    }
}
</script>
{% endblock %}
